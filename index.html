<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dossiê de Visitas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
    h1 { color: #333; }
    .tabs {
      display: flex;
      flex-direction: column;
      max-width: 250px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px;
      background-color: #e0e0e0;
      margin-bottom: 5px;
      border-radius: 8px;
      cursor: pointer;
    }
    .tab:hover {
      background-color: #ccc;
    }
    .content {
      margin-left: 270px;
      position: absolute;
      top: 20px;
    }
    .house-image {
      text-align: center;
    }
    .house-image img {
      max-width: 400px;
      border-radius: 12px;
    }
    .house-info, .house-table {
      margin-top: 20px;
      font-size: 16px;
    }
    .house-price {
      font-size: 22px;
      font-weight: bold;
      margin-top: 10px;
    }
    .house-table table {
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
    }
    .house-table td, .house-table th {
      border: 1px solid #ccc;
      padding: 8px;
      background-color: #fff;
    }
    .welcome-message {
      font-size: 18px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Dossiê de Visitas</h1>
  <div class="tabs" id="tabs"></div>
  <div class="content" id="content">
    <div class="welcome-message">Bem-vindo ao Dossiê de Visitas do QuintoAndar. Selecione um imóvel ao lado para começar.</div>
  </div>

  <script>
    async function carregarCSV() {
      const response = await fetch('dados.csv?v=' + new Date().getTime());
      const csvText = await response.text();

      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const tabs = document.getElementById("tabs");
          const content = document.getElementById("content");

          const groupedByHouse = {};
          data.forEach(item => {
            if (!groupedByHouse[item.sk_house]) groupedByHouse[item.sk_house] = [];
            groupedByHouse[item.sk_house].push(item);
          });

          Object.keys(groupedByHouse).forEach(house => {
            const tab = document.createElement("div");
            tab.className = "tab";
            tab.textContent = house;
            tab.onclick = () => renderHouse(house);
            tabs.appendChild(tab);
          });

          function renderHouse(houseId) {
            const houseItems = groupedByHouse[houseId];
            if (!houseItems || houseItems.length === 0) return;
            const main = houseItems[0];

            content.innerHTML = `
              <div class="house-image">
                <div><strong>${main.house_address}, ${main.house_neighborhood}</strong></div>
                <img src="https://www.quintoandar.com.br/img/${main.name}" alt="Imagem do imóvel">
                <div class="house-info">
                  Área: ${main.house_total_area} m² | Quartos: ${main.house_bedrooms} | Banheiros: ${main.house_bathrooms} | Vagas: ${main.house_garages}
                </div>
                <div class="house-price">
                  <a href="https://www.quintoandar.com.br/imovel/${main.sk_house}/comprar/" target="_blank">Imóvel da sua visita no site</a><br>
                  R$ ${parseFloat(main.price).toLocaleString('pt-BR')}
                </div>
              </div>
              <div class="house-table">
                <table>
                  <tr><td>Data da visita</td><td>${main.dt_visita || ''}</td></tr>
                  <tr><td>Hora da visita</td><td>${main.hr_visita || ''}</td></tr>
                  <tr><td>Dias Publicado</td><td>${main.days_published}</td></tr>
                  <tr><td>Ofertas</td><td>${main.os}</td></tr>
                  <tr><td>Visitas</td><td>${main.vb}</td></tr>
                  <tr><td>Primeiro Preço</td><td>${main.floor}</td></tr>
                  <tr><td>Preço Atual</td><td>${main.price}</td></tr>
                  <tr><td>Diagn. de Preço</td><td>${((main.price - main.predicted_price_70)/main.price).toFixed(2)}</td></tr>
                  <tr><td>Último Desconto</td><td>${main.last_price_down}</td></tr>
                  <tr><td>% Desconto</td><td>${main.previous_price_variation}</td></tr>
                  <tr><td>Última Oferta</td><td>${main.date}</td></tr>
                  <tr><td>Status Oferta</td><td>${main.monday_status}</td></tr>
                  <tr><td>Valor Ofertado</td><td>${main.sale_price_agreed}</td></tr>
                </table>
              </div>
            `;
          }
        }
      });
    }

    carregarCSV();
  </script>
</body>
</html>
