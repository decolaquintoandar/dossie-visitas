<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dossi√™ de Visitas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; display: flex; }
    h1 { color: #333; margin-bottom: 0; }
    .subtitle { font-size: 18px; color: #555; margin-bottom: 20px; }
    .sidebar {
      width: 250px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin-right: 20px;
      height: fit-content;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: sticky;
      top: 20px;
      scroll-behavior: smooth;
    }
    .sidebar h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    .skhouse-item {
      padding: 10px;
      margin-bottom: 6px;
      background-color: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      color: #333;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: background-color 0.2s;
    }
    .skhouse-item:hover {
      background-color: #e0e0e0;
    }
    .skhouse-item.selected {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3; 
      font-weight: bold;
    }
    .skhouse-section-title {
      margin: 14px 0 8px;
      font-size: 13px;
      font-weight: bold;
      background-color: #e0f7fa;
      color: #00796b;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-block;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .titulo-imovel-visita {
      font-size: 18px;
      font-weight: bold;
      color: #7f8c8d;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
      padding-bottom: 4px;
      text-align: left;
    }
    .sidebar.hidden {
    display: none;
    }
    #toggleSidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: #0077cc;
      border: none;
      border-radius: 50%;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #toggleSidebar svg {
      width: 20px;
      height: 20px;
      fill: white;
      transition: transform 0.3s ease;
    }
    #toggleIcon {
      display: inline-block;
      transition: transform 0.3s;
      border: none;
      outline: none;
      background: none;
      font-size: 20px;
      line-height: 1;
    }
    .main { flex: 1; }
    .placeholder { margin-top: 40px; font-size: 18px; color: #666; }
    .imovel-container { text-align: center; margin-top: 40px; }
    .imovel-grid { display: flex; gap: 40px; justify-content: center; margin-top: 20px; margin-bottom: 40px; flex-wrap: wrap; }
    .imovel-imagem { max-width: 500px; text-align: center; }
    .imovel-imagem img { width: 400px; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    .imovel-endereco { font-weight: bold; font-size: 18px; margin-bottom: 10px; text-align: center; }
    .imovel-infos { margin-top: 12px; font-size: 16px; color: #444; text-align: center; }
    .imovel-preco { font-size: 20px; font-weight: bold; margin-top: 8px; text-align: center; }
    .imovel-link { margin-top: 8px; font-size: 15px; text-align: center; }
    .imovel-detalhes { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 20px; width: 320px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
    .imovel-detalhes table { width: 100%; border-collapse: collapse; }
    .imovel-detalhes th, .imovel-detalhes td { text-align: left; padding: 6px 4px; font-size: 14px; }
    .imovel-detalhes th { color: #555; width: 50%; }
    .tags { margin-top: 16px; text-align: center; }
    .tag { display: inline-block; margin: 4px; background-color: #e0f7fa; padding: 6px 12px; border-radius: 20px; font-size: 14px; color: #00796b; }
    .header-logo { max-width: 200px; margin-bottom: 20px; background-color: #f9f9f9; padding: 8px; border-radius: 8px; }
    .similares-grid { display: grid; justify-content: center; gap: 24px; grid-template-columns: repeat(3, 1fr); }
    .card-similar { background: white; border-radius: 6px; width: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding-bottom: 12px; max-width: 320px;}
    .card-similar img {  width: 100%; height: 260px; object-fit: cover; border-top-left-radius: 6px; border-top-right-radius: 6px;}
    .card-similar .titulo { font-weight: bold; background-color: #f6f6f6; padding: 6px 0; }
    .card-similar .info, .card-similar .endereco, .card-similar .preco, .card-similar .tags, .card-similar .link { padding: 4px 10px; font-size: 14px; }
    .card-similar .preco { font-weight: bold; font-size: 16px; margin-top: 4px; }
    .card-similar .tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .card-similar .tag { font-size: 12px; padding: 4px 8px; }
    .card-similar .link a { text-decoration: none; color: #0077cc; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .imagem-similar {width: 100%; height: 260px; object-fit: cover; border-top-left-radius: 6px; border-top-right-radius: 6px; margin-bottom: 8px; aspect-ratio: 1 / 1;}
  </style>
</head>
<body>
  <div class="sidebar hidden">
    <h2>Im√≥veis com dossi√™</h2>
    <div style="font-size: 13px; color: #555; margin-bottom: 12px;">üèòÔ∏è Similares no mesmo condom√≠nio</div>
    <div id="skhouse-list"></div>
  </div>

  <button id="toggleSidebar" title="Mostrar/ocultar lista">
    <svg id="toggleIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
      <path d="M1 8a.5.5 0 0 1 .5-.5h10.793L9.146 4.354a.5.5 0 1 1 .708-.708l4.5 4.5a.5.5 0 0 1 0 .708l-4.5 4.5a.5.5 0 0 1-.708-.708L12.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
    </svg>
  </button>

  <div class="main" style="display: none;">

    <div id="login-container" style="margin-top: 40px; font-size: 16px; color: #333;">
      <label for="loginInput">Digite seu ID de corretor ou a senha:</label><br><br>
      <input id="loginInput" type="text" placeholder="ID do corretor ou senha" style="padding: 8px; width: 260px; border: 1px solid #ccc; border-radius: 6px;"><br><br>
      <button onclick="validarLogin()" style="padding: 8px 16px; background-color: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer;">Entrar</button>
    </div>
    
    <img src="logo_quintoandar.png" alt="Logo QuintoAndar" class="header-logo">

    <h1 style="display: flex; align-items: center; gap: 12px;">
      Dossi√™ de Visitas
      <button id="btnCompartilharImagem" style="background-color: #2196f3; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
        üì§ Compartilhar com o comprador
      </button>
    </h1>
    
    <div id="placeholder" class="placeholder">Bem-vindo ao Dossi√™ de Visitas do QuintoAndar. Selecione um im√≥vel ao lado para visualizar os detalhes.</div>
    <div id="imovel" class="imovel-container" style="display: none;"></div>
  </div>

  <script>
    function formatarDataBR(dataStr) {
      if (!dataStr) return "-";
      const d = new Date(dataStr);
      return d instanceof Date && !isNaN(d) ? d.toLocaleDateString("pt-BR") : dataStr;
    }

    function getParametroUrl(nome) {
      const url = new URL(window.location.href);
      return url.searchParams.get(nome);
    }

    function formatarReais(valor) {
      return valor ? `R$ ${Number(valor).toLocaleString("pt-BR")}` : "-";
    }

    function formatarPercentual(valor) {
      const num = parseFloat(valor);
      if (isNaN(num)) return "-";
      return `${(num * 100).toFixed(1).replace('.', ',')}%`;
    }

    function validarLogin() {
      const entrada = document.getElementById("loginInput").value.trim();
      const url = new URL(window.location.href);
    
      if (entrada === "decolaseusclientes") {
        url.searchParams.set("corretor", entrada);
        window.location.href = url.toString();
      } else if (entrada && !isNaN(entrada)) {
        url.searchParams.set("corretor", entrada);
        window.location.href = url.toString();
      } else {
        alert("Acesso negado. Digite um ID v√°lido ou a senha.");
      }
    }
    async function carregarCSV() {
      const response = await fetch('dados.csv?v=' + new Date().getTime());
      const csvText = await response.text();

      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const skhouseList = document.getElementById("skhouse-list");
          const placeholder = document.getElementById("placeholder");
          const imovelContainer = document.getElementById("imovel");

          function atualizarDossie(filtro = "", filtroSkhouse = null) {
            skhouseList.innerHTML = "";
            imovelContainer.innerHTML = "";

            const corretorFiltrado = getParametroUrl("corretor");
            const dataFiltrada = (corretorFiltrado && corretorFiltrado !== "decolaseusclientes")
              ? data.filter(item => item["id_corretor"] === corretorFiltrado)
              : data;
            
            skhouseSelecionado = filtroSkhouse;
            
            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];
            const amanha = new Date(hoje);
            amanha.setDate(hoje.getDate() + 1);
            const amanhaStr = amanha.toISOString().split('T')[0];

            const visitasHoje = dataFiltrada.filter(l => l["dt_visita"] === hojeStr);
            const visitasAmanha = dataFiltrada.filter(l => l["dt_visita"] === amanhaStr);
            const outrasVisitas = dataFiltrada.filter(l => l["dt_visita"] !== hojeStr && l["dt_visita"] !== amanhaStr)
                                       .sort((a, b) => new Date(a["dt_visita"]) - new Date(b["dt_visita"]));

            function adicionarSecao(titulo, lista) {
              if (lista.length === 0) return;
              const header = document.createElement("div");
              header.className = "skhouse-section-title";
              header.textContent = `${titulo}`;
              skhouseList.appendChild(header);

              lista.forEach(linha => {
                const div = document.createElement("div");
                div.className = "skhouse-item";
                if (linha["sk_house"] === skhouseSelecionado) {
                  div.classList.add("selected");
                }
                const temMesmoCondominio = data.some(outro =>
                  outro["sk_house"] !== linha["sk_house"] &&
                  Array.from({ length: 9 }, (_, i) => outro[`similar listing info ${i + 1}`])
                    .filter(info => info && info.includes("/"))
                    .some(info => {
                      const primeiroParametro = info.split("/")[0].trim().toLowerCase();
                      return primeiroParametro.includes("mesmo condom√≠nio") && info.includes(linha["sk_house"]);
                    })
                );
                
                const enderecoTexto = `${linha["house_address"]}, ${linha["house_neighborhood"]}`;
                div.innerHTML = `
                  <div style="display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: row; text-align: center;">
                    ${temMesmoCondominio ? '<span style="font-size: 16px;">üèòÔ∏è</span>' : ''}
                    <span style="font-size: 14px; line-height: 1.2;">${enderecoTexto}</span>
                  </div>
                `;
                div.addEventListener("click", () => {
                  document.querySelectorAll(".skhouse-item").forEach(el => el.classList.remove("selected"));
                  div.classList.add("selected");
                  atualizarDossie("", linha["sk_house"]);
                });
                skhouseList.appendChild(div);
              });
            }

            adicionarSecao("Visitas de Hoje", visitasHoje);
            adicionarSecao("Visitas de Amanh√£", visitasAmanha);
            adicionarSecao("Outras Visitas", outrasVisitas);

            if (!filtroSkhouse) {
              imovelContainer.style.display = "none";
              placeholder.style.display = "block";
              return;
            }

            const imovel = dataFiltrada.find(l => l["sk_house"] === filtroSkhouse);
            if (imovel) {
              const tituloSessao = document.createElement("div");
              tituloSessao.className = "titulo-imovel-visita";
              tituloSessao.textContent = "Im√≥vel da visita";
              
              imovelContainer.appendChild(tituloSessao);
              
              const grid = document.createElement("div");
              grid.className = "imovel-grid";

              const imagemCol = document.createElement("div");
              imagemCol.className = "imovel-imagem";
              const endereco = document.createElement("div");
              endereco.className = "imovel-endereco";
              endereco.textContent = `${imovel["house_address"]}, ${imovel["house_neighborhood"]}`;
              const img = document.createElement("img");
              img.src = `https://www.quintoandar.com.br/img/${imovel["name"]}`;
              const infos = document.createElement("div");
              infos.className = "imovel-infos";
              infos.textContent = `${imovel["house_total_area"]} m¬≤ | ${imovel["house_bedrooms"]} quarto(s) | ${imovel["house_bathrooms"]} ban. | ${imovel["house_garages"]} vaga(s)`;

              const tags = document.createElement("div");
              tags.className = "tags";
              const quinzeDiasAtras = new Date(hoje);
              quinzeDiasAtras.setDate(hoje.getDate() - 15);
              if (Number(imovel["price"]) <= Number(imovel["predicted_price_70"])) tags.innerHTML += '<div class="tag">üí≤ Super Pre√ßo</div>';
              if (imovel["last_price_down"] && new Date(imovel["last_price_down"]) >= quinzeDiasAtras) tags.innerHTML += '<div class="tag">‚¨áÔ∏è Redu√ß√£o recente</div>';
              if (Number(imovel["vb"]) > 5) tags.innerHTML += '<div class="tag">‚≠ê Muitas visitas</div>';

              const preco = document.createElement("div");
              preco.className = "imovel-preco";
              preco.textContent = formatarReais(imovel["price"]);
              const link = document.createElement("div");
              link.className = "imovel-link";
              link.innerHTML = `<a href="https://www.quintoandar.com.br/imovel/${imovel["sk_house"]}/comprar/" target="_blank">Im√≥vel da sua visita no site</a>`;
              
              imagemCol.appendChild(endereco);
              imagemCol.appendChild(img);
              imagemCol.appendChild(infos);
              imagemCol.appendChild(tags);
              imagemCol.appendChild(preco);
              imagemCol.appendChild(link);
              grid.appendChild(imagemCol);

              const detalhesCol = document.createElement("div");
              detalhesCol.className = "imovel-detalhes";
              const tabela = document.createElement("table");

              const diag = ((imovel["price"] - imovel["predicted_price_70"]) / imovel["price"]);
              const diagLabel = isNaN(diag) ? "-" : `${(diag * 100).toFixed(1).replace('.', ',')}% ${diag >= 0 ? 'acima do ideal' : 'abaixo do ideal'}`;

              const rows = [
                ["Data da visita", formatarDataBR(imovel["dt_visita"])],
                ["Hora da visita", imovel["hr_visita"] || "-"],
                ["Dias Publicado", imovel["days_published"]],
                ["Ofertas", imovel["os"]],
                ["Visitas", imovel["vb"]],
                ["Primeiro Pre√ßo", formatarReais(imovel["floor"])],
                ["Pre√ßo Atual", formatarReais(imovel["price"])],
                ["Diagn. de Pre√ßo", diagLabel],
                ["√öltimo Desconto", formatarDataBR(imovel["last_price_down"])],
                ["% Desconto", formatarPercentual(imovel["previous_price_variation"])],
                ["√öltima Oferta", formatarDataBR(imovel["date"])],
                ["Status Oferta", imovel["monday_status"] || "-"],
                ["Valor Ofertado", formatarReais(imovel["sale_price_agreed"])],
              ];
              rows.forEach(([label, valor]) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<th>${label}</th><td>${valor}</td>`;
                tabela.appendChild(tr);
              });
              detalhesCol.appendChild(tabela);
              grid.appendChild(detalhesCol);
              
              imovelContainer.appendChild(grid);

              const tituloSimilares = document.createElement("div");
              tituloSimilares.className = "titulo-imovel-visita";
              tituloSimilares.textContent = "Im√≥veis Similares";
              imovelContainer.appendChild(tituloSimilares);

              const similaresGrid = document.createElement("div");
              similaresGrid.className = "imovel-grid";
              
              // Percorre de similar_1 at√© similar_9
              for (let i = 1; i <= 9; i++) {
                const idImovel = imovel[`similar listing ${i}`];
                const infoCampo = imovel[`similar listing info ${i}`];
              
                if (!idImovel || !infoCampo || !infoCampo.includes("/")) continue;
              
                const partes = infoCampo.split("/");
                const [distancia, fotoUrlRaw, info, endereco, preco, tag1, tag2, tag3] = partes;

                const fotoUrl = fotoUrlRaw.trim();
                
                const card = document.createElement("div");
                card.className = "imovel-detalhes";
                card.style.width = "280px";
                card.style.textAlign = "center";
              
                const imagem = document.createElement("img");
                imagem.src = `https://www.quintoandar.com.br/img/${fotoUrl}`;
                imagem.className = "imagem-similar";
                card.appendChild(imagem);
              
                const titulo = document.createElement("div");
                titulo.textContent = distancia.substring(3); 
                titulo.style.backgroundColor = "#dfdfdf";    
                titulo.style.color = "#000000";            
                titulo.style.padding = "10px 0";
                titulo.style.fontSize = "16px";
                titulo.style.fontWeight = "bold";
                titulo.style.textAlign = "center";
                titulo.style.width = "100%";
                titulo.style.borderRadius = "10px";
                titulo.style.marginBottom = "10px";
                card.appendChild(titulo);
                              
                const infos = document.createElement("div");
                infos.style.fontSize = "14px";
                infos.style.color = "#555";
                infos.textContent = info;
                card.appendChild(infos);
              
                const end = document.createElement("div");
                end.style.fontSize = "14px";
                end.style.color = "#333";
                end.style.margin = "6px 0";
                end.textContent = endereco;
                card.appendChild(end);
              
                const valor = document.createElement("div");
                valor.style.fontWeight = "bold";
                valor.style.marginTop = "4px";
                valor.textContent = formatarReais(preco);
                card.appendChild(valor);
              
                const tagsArray = [tag1, tag2, tag3].filter(tag => tag && tag.trim() !== "");
                if (tagsArray.length > 0) {
                  const tags = document.createElement("div");
                  tags.style.fontSize = "13px";
                  tags.style.margin = "6px 0";
                  tags.style.display = "flex";
                  tags.style.flexWrap = "wrap";
                  tags.style.gap = "4px";
                  tags.style.justifyContent = "center";
                
                  tagsArray.forEach(tag => {
                    const span = document.createElement("div");
                    span.className = "tag";
                    if (tag.includes("Super pre√ßo")) {
                      span.textContent = "üí≤ " + tag;
                    } else if (tag.includes("Redu√ß√£o")) {
                      span.textContent = "‚¨áÔ∏è " + tag;
                    } else if (tag.includes("Muitas visitas")) {
                      span.textContent = "‚≠ê " + tag;
                    } else {
                      span.textContent = tag;
                    }
                    tags.appendChild(span);
                  });
                
                  card.appendChild(tags);
                }

                const linkWrapper = document.createElement("div");
                linkWrapper.style.marginTop = "12px";
                linkWrapper.style.textAlign = "center";
                
                const link = document.createElement("a");
                link.href = `https://www.quintoandar.com.br/imovel/${idImovel}/comprar/`;
                link.target = "_blank";
                link.textContent = "Clique para acessar o im√≥vel!";
                link.style.display = "inline-flex";
                link.style.alignItems = "center";
                link.style.gap = "6px";
                link.style.textDecoration = "none";
                link.style.color = "#0077cc";
                link.style.fontWeight = "bold";
                link.style.fontSize = "14px";
                
                link.addEventListener("mouseover", () => link.style.color = "#005fa3");
                link.addEventListener("mouseout", () => link.style.color = "#0077cc");
                
                const icon = document.createElement("span");
                icon.textContent = "üîó";
                link.prepend(icon);
                
                linkWrapper.appendChild(link);
                card.appendChild(linkWrapper);

              
                similaresGrid.appendChild(card);
              }

              imovelContainer.appendChild(similaresGrid);
              
              placeholder.style.display = "none";
              imovelContainer.style.display = "block";
              document.getElementById("btnCompartilhar").style.display = "inline-block";
              document.querySelector(".sidebar").classList.add("hidden");
              document.getElementById("toggleIcon").style.transform = "rotate(180deg)";

            }
          }

          const corretorFiltrado = getParametroUrl("corretor");

          if (corretorFiltrado === "decolaseusclientes" || (corretorFiltrado && !isNaN(corretorFiltrado))) {
            atualizarDossie();
          }
        }
      });
    }
    let skhouseSelecionado = null;
    window.onload = () => {
      const url = new URL(window.location.href);
      const corretorParam = url.searchParams.get("corretor");
    
      if (corretorParam) {
        document.querySelector(".sidebar").classList.remove("hidden");
        document.querySelector(".main").style.display = "block";
        document.getElementById("login-container").style.display = "none";
        carregarCSV();
      } else {
        // Mostra apenas a tela de login
        document.querySelector(".main").style.display = "block";
        document.getElementById("login-container").style.display = "block";
      }
    };
    
      document.getElementById("toggleSidebar").addEventListener("click", () => {
          const sidebar = document.querySelector(".sidebar");
          const icon = document.getElementById("toggleIcon");
        
          const isHidden = sidebar.classList.contains("hidden");
        
          if (isHidden) {
            sidebar.classList.remove("hidden");
            icon.style.transform = "rotate(0deg)";
          } else {
            sidebar.classList.add("hidden");
            icon.style.transform = "rotate(180deg)";
          }
        });

        function carregarImagemComoBase64(url) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = img.naturalWidth;
              canvas.height = img.naturalHeight;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);
              resolve(canvas.toDataURL("image/jpeg", 0.9));
            };
            img.onerror = reject;
            img.src = url;
          });
        }
    
        document.getElementById("btnCompartilharImagem").addEventListener("click", async () => {
          const sidebar = document.querySelector(".sidebar");
          const toggleBtn = document.getElementById("toggleSidebar");
          const compartilharBtn = document.getElementById("btnCompartilhar");
          const compartilharImagemBtn = document.getElementById("btnCompartilharImagem");
          const main = document.querySelector(".main");
        
          // Oculta a sidebar e bot√µes
          sidebar.classList.add("hidden");
          toggleBtn.classList.add("hidden");
          compartilharImagemBtn.classList.add("hidden");
        
          const originalScroll = document.documentElement.scrollTop;
          const originalHeight = main.style.height;
        
          window.scrollTo(0, 0); // Garante que o topo esteja vis√≠vel
          main.style.height = "auto"; // Expande para capturar tudo
        
          await new Promise(r => setTimeout(r, 300)); // Espera renderizar
        
          html2canvas(main, { scale: 2 }).then(canvas => {
            const link = document.createElement("a");
            link.download = "dossie-visita.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        
            // Restaura tudo
            sidebar.classList.remove("hidden");
            toggleBtn.classList.remove("hidden");
            compartilharImagemBtn.classList.remove("hidden");
            main.style.height = originalHeight;
            window.scrollTo(0, originalScroll);
          });
        });


  </script>
</body>
</html>
